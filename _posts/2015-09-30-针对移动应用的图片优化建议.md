---
layout: post
title: "针对移动应用的图片优化建议"
date: 2015-09-30 22:32:00
description: '移动应用中通过对图片优化来提高加载速度的可行思路'
tags:
- mobile
- design
- origin
categories:
- design
twitter_text: "mobile apps' image principle"
comments: true
---

由于经验上的欠缺，在写一个电商项目的时候对图片这件事太掉以轻心，在配置首页的动画效果的时候客户方配置了大量的大尺寸大图片在一个一个页面上，导致整个页面出现了不仅仅是加载慢的问题，甚至造成了APP的闪退。后来在我们试着对图片进行尺寸缩小和体积压缩之后再部署到APP上，上述问题都得到解决。此后关于移动端图片应该怎么优化我又找了些资料并且对几个图片使用很频繁的电商平台的移动端页面图片进行研究，总结出一些实践思路希望从图片这一块在既能保证显示效果的情况下又能尽可能的提高页面的加载和渲染表现。 
  

PC端对图片的使用要更宽松一些，一是PC端计算资源更为富余，二是一般PC网络带宽也更为宽裕。移动端特别需要注意的一点是如果图片不做相应的控制，页面的浏览会消耗大量的网络流量，用户可能后来就不敢使用该产品。更大的图片对服务器带宽也会是一个更大的挑战，也是页面上加载最为耗时的过程，也一直是优化的重点。   

首先我们有必要了解一下现在web页面主要的图片格式以及他们的主要区别。   
web图片总体上分为矢量图与位图。    

+ [矢量图](https://zh.wikipedia.org/zh/%E7%9F%A2%E9%87%8F%E5%9B%BE%E5%BD%A2)一般的格式为SVG，是基于 XML 的图片格式，适用于二维图片。可以将 SVG 标记直接嵌入网页，也可以作为外部资源嵌入。而且无论怎么缩放都不会出现图形边缘的锯齿。适用于规则几何图形组成的图片，对于特别复杂的图片可能会产生更大的文件，计算和渲染会更为缓慢。   

+ [位图](https://zh.wikipedia.org/wiki/%E4%BD%8D%E5%9B%BE)中主流的几种格式为jpg/png/gif。一般图片的尺寸越大，颜色变化越丰富，图案越复杂则图片的文件体积也会越大。而且由于是为每一个像素编码图片数据所以实现效果也和像素数量紧密相关。[三种格式的区别](http://www.howtogeek.com/howto/30941/whats-the-difference-between-jpg-png-and-gif/)其实是非常有必要了解的。 现在还出现了新的适应web的图片格式[webp][]和[jpeg-xr][]，这两种格式现在还不普及但是特性更好。     


了解了关于图片的基本知识，那些使用图片很多的电商网站对图片的使用上都有哪些特点呢？   
针对这个疑问，可以使用浏览器设置为手机模式观察他们网站图片的特点，总结如下：    

+ 图片尺寸整齐。      
	各个固定位置的显示图片的原始尺寸都是一样的，通常和展示区域的大小成比例。 

+ 各显示区域有不同尺寸。   
	即使是同样的图片在小的显示区域会使用小图，而在大的显示区域则图片的原始尺寸也会更大。这个其实可以在nginx中配置http_image_filter_module就可以做到。并且对图片没有使用gzip压缩。事实上这种资源确实是没必要压缩的，[看这里](http://webmasters.stackexchange.com/questions/8382/gzipped-images-is-it-worth)。   

+ 在海报页面灵活使用雪碧图。     
	在京东的海报页面我们看到三个一列的商品被做成一整张图片，使用html中的map标签来对图片进行区域划分，实现不同的区域链接到不同的商品。这样减少了connection的数量，提高资源下载速度。   

+ 图片的复杂程度和尺寸动态平衡。     
	不同复杂性，不同重要程度的图片使用不同的尺寸。例如在商品页面上部的商品轮播大图尺寸为800*800。同样是占满整屏宽度，在商品详情页面，图片宽度则通常只有640。而且考虑到详情页面的图片内容颜色和内容更加丰富，尺寸的增大会导致文件体积的大幅增加，这样做也有其合理性。       


如果已经了解了关于图片的各种方面，那么参考网络上的一些文章加上自己的思考，我们总结了以下这些针对图片的调优方法。


1. 格式；到底用哪种格式最好    
	根据要表现的内容的特点，首先需要确定的是我们打算怎么展示它，以哪种载体。首先一些相对简单的效果如果能用越来越强大的CSS来表现当然是最好的。其次考虑可不可以使用矢量图。如果前两种都不太理想，还可以考虑使用IconFont最后才是考虑是否该用图片。如果需要透明效果，那么png是不二的选择。对于png，多彩图片使用png24，低彩图片使用png8，jpg格式也有多种编码格式可以切换。合适的选择表现的载体是最重要的。     

2. 尺寸：不同情况精确控制    
	图片的尺寸直接和文件大小正相关，不论是哪种图片格式都是如此，优化图片我们首先应该关注图片的尺寸。移动端设备屏幕的分辨率在不断提高现在2K屏幕在各品牌旗舰机上几乎已经普及，但是需要注意的是实际页面布局使用的分辨率是CSS分辨率，两者并不相同。iphone6plus屏幕的CSS尺寸是414*736，一个CSS像素包含多个屏幕像素。实际显示的时候图片，图片会按照实际的CSS像素尺寸进行缩放，不仅会消耗CPU计算资源而且大图片也会以较低的分辨率显示。将图片尺寸缩小到和CSS尺寸一致才是最优的情况。所以在不同大小的显示区域提供不同缩放比例的图片十分有必要。     

3. 压缩：优秀工具大幅减少文件大小     
	现在市面上出现了非常多的针对各种格式图片的压缩工具，通常使用这些工具进行适当压缩之后能在肉眼分辨不出明显区别的情况下将体积大幅压缩。例如针对png的有损压缩[pngquant][]和无损压缩[optipng][]，和对jpg进行压缩和转码的[jpegtran][]，以及对gif的[gifsicle][]。矢量图是基于xml的图片格式。SVG 文件应进行缩减，以减小文件大小。并且还能使用gzip进行压缩以减少传输文件大小。图片压缩不是一个一套方案通吃的事情，针对不同显示质量要求应使用不同的压缩质量以达到图片质量和文件大小的最佳平衡点。      
4. 雪碧图：减少资源connection    
	浏览器会对加载网页的连接数有限制。不同浏览器做的限制不同，例如chrome34对每个域名的访问限制为6，对总连接限制为10。加载网页的时候如果需要加载的资源很多，浏览器会让资源排队依次下载下来。下载一个资源不仅需要重新DNS解析和初始化连接，还要单独发送一个request请求，之后等待服务器返回资源，最后下载的时候往往很短，但前面这些却消耗很多时间。而如果使用雪碧图，一次性对多个资源进行下载可以加快页面图片的加载速度。    

5. 删除：删除不必要的图片元数据     
	许多光栅图包含不必要的资源元数据：地理信息、相机信息等。使用适合的工具删除这些数据可以减小文件大小，而且使图片的信息更加简洁和整齐，对大量图片做这种优化效果会更加明显。   

6. 新格式：webp和jpeg-xr容易获得更好的性能      
	webp和jpeg-xr在设计的时候就对web做了考虑，webp支持无损和有损压缩，无损模式下支持透明度但同样情况下平均比png小26%，有损模式下比jpg要小25%-34%。在服务器能增加一个判断逻辑来检测客户端格式的情况下应该尝试使用。    

图片的优化并不是一个模式就能包打天下的事情，不同的情况需要不同的处理，但是图片一直是web加载耗时最多的地方，注意图片的优化是web页面优化的关键的一步。




参考文章和拓展阅读:    
[h5 performance](http://isux.tencent.com/h5-performance.html)   
[image optimization](https://developers.google.com/web/fundamentals/performance/optimizing-content-efficiency/image-optimization?hl=zh-cn)   
[移动前端系列——移动页面性能优化](http://tgideas.qq.com/webplat/info/news_version3/804/808/811/m579/201412/293834.shtml)   
[Maximum concurrent connections to the same domain for browsers](http://sgdev-blog.blogspot.com/2014/01/maximum-concurrent-connection-to-same.html)   

在线工具:    
[智图](http://zhitu.isux.us/)      
[图片优化的那些工具](http://ued.ctrip.com/blog/image-optimization-tools.html)   
[browserscope](http://www.browserscope.org/?category=network)     
 

[webp]:https://developers.google.com/speed/webp/
[jpeg-xr]:https://en.wikipedia.org/wiki/JPEG_XR
[optipng]:http://optipng.sourceforge.net/
[gifsicle]:http://www.lcdf.org/gifsicle/
[pngquant]:http://pngquant.org/
[jpegtran]:http://jpegclub.org/jpegtran/
